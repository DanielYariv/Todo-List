<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ToDo-DanielY</title>

    <!-- boostrap  -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
    />

    <style>
      .btn-circle {
        border-radius: 20px;
      }
      .alertP {
        color: red;
        margin-left: 4px;
        font-size: 10px;
      }
      .priority {
        width: 35%;
        text-align: center;
        height: 1.3rem;
      }
      .form-check-input[type="checkbox"] {
        border-radius: 50em;
      }

      .list-group-item {
        background-color: grey;
      }

      .bi-pencil:hover,
      .bi-trash3:hover,
      #expandDeletedBtn:hover,
      .bi-clipboard-check:hover,
      .form-check-input:hover {
        cursor: pointer;
      }
      .gradient {
        background: linear-gradient(#28313b, #485461);
      }
      .checkBox {
        background: grey;
      }
      .trash,
      .pencil {
        display: none;
      }
      .list-group-item:hover .trash,
      .list-group-item:hover .pencil {
        display: inline-block;
        justify-content: space-between;
      }
    </style>
  </head>
  <body>
    <section class="vh-100 gradient">
      <div class="container py-5 h-100">
        <div class="row d-flex justify-content-center align-items-center h-100">
          <div class="col col-xl-10">
            <!-- bav bar -->
            <ul class="nav nav-tabs mb-4 pb-2" id="ToDoNav" role="tablist">
              <li
                id="allTasksNav"
                class="nav-item nav-link"
                role="presentation"
              >
                All
              </li>
              <li id="deletedNav" class="nav-item nav-link" role="presentation">
                Deleted
              </li>
              <li id="summaryNav" class="nav-item nav-link" role="presentation">
                Summary
              </li>
            </ul>

            <h1>To Do</h1>

            <!-- Button to trigger add task modal -->
            <span
              ><button
                type="button"
                id="addTaskModalBtn"
                class="btn btn-danger btn-circle"
                data-bs-toggle="modal"
                data-bs-target="#taskModal"
              >
                <i class="bi bi-plus"></i>
              </button>
            </span>

            <!-- tasks card -->
            <div id="taskDiv" class="card" style="width: 18rem">
              <ul id="dynamicUl" class="list-group list-group-flush">
                <li class="list-group-item">
                  <h5 class="card-title">
                    go to gym
                    <input
                      class="form-check-input checkBox"
                      type="checkbox"
                      value=""
                      aria-label="..."
                      onclick="deleteTaskFunc(123)"
                    />
                  </h5>
                  <h6 class="card-subtitle mb-2 text-body-secondary">
                    <i class="bi bi-calendar" onclick="deleteTaskFunc(123)"></i>
                    10:00, 23.04
                  </h6>
                </li>
                <li class="list-group-item">
                  <h5 class="card-title">
                    Card title
                    <input
                      class="form-check-input checkBox"
                      type="checkbox"
                      value=""
                    />
                  </h5>
                  <h6 class="card-subtitle mb-2 text-body-secondary">
                    Card subtitle
                  </h6>
                </li>
              </ul>
            </div>

            <!-- summarize card -->
            <h1>summary</h1>
            <div id="summaryDiv" class="card" style="width: 18rem">
              <ul class="list-group list-group-flush">
                <li class="list-group-item">
                  <h5 class="card-title">Today Tasks:</h5>
                  <h6
                    id="dynamicCompletedToday"
                    class="card-subtitle mb-2 text-body-secondary"
                  ></h6>
                </li>
                <li class="list-group-item">
                  <h5 class="card-title">Total Completed Tasks:</h5>
                  <h6
                    id="dynamicCompleted"
                    class="card-subtitle mb-2 text-body-secondary"
                  ></h6>
                </li>
                <li class="list-group-item">
                  <h5 class="card-title">Total deleted Tasks:</h5>
                  <h6
                    id="dynamicDeleted"
                    class="card-subtitle mb-2 text-body-secondary"
                  >
                    <span id="dynamicTotalDeleted"></span>
                    <i
                      id="expandDeletedBtn"
                      class="bi bi-chevron-expand border border-dark border-1 rounded-pill"
                    ></i>
                  </h6>
                </li>
              </ul>
            </div>

            <!-- deleted Card -->
            <h1>Deleted Tasks</h1>
            <div id="deleteDiv" class="card" style="width: 18rem">
              <ul
                id="deletedCard"
                class="list-group list-group-flush"
                style="display: none"
              ></ul>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- add task modal -->
    <div
      class="modal fade"
      id="taskModal"
      tabindex="-1"
      aria-labelledby="taskModal"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="taskModalLabel">New Task</h5>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <input
                type="text"
                class="form-control"
                id="taskName"
                placeholder="Task Name"
              />
              <p id="taskNameP" class="alertP"></p>
            </div>
            <div class="mb-3">
              <select id="prioritySelect" class="form-select">
                <option style="display: none" value="" selected>
                  Priority
                </option>
                <option value="1">High</option>
                <option value="2">Medium</option>
                <option value="3">Low</option>
              </select>
              <p id="priorityP" class="alertP"></p>
            </div>
            <div class="mb-3">
              <input type="date" id="chooseDate" class="form-control" />
              <p id="dateP" class="alertP"></p>
            </div>
          </div>
          <div class="modal-footer">
            <button
              id="addTaskBtn"
              type="button"
              class="btn btn-danger btn-circle"
            >
              <i class="bi bi-arrow-up"></i>
            </button>
            <button
              id="editTaskBtn"
              type="button"
              class="btn btn-danger btn-circle"
            >
              <i class="bi bi-pencil"></i>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- bootstrap  -->
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>

    <!-- TODO:change this to js file -->
    <script>
      //variable for navBar toggle handling
      let allTasksNav = document.getElementById("allTasksNav");
      let summaryNav = document.getElementById("summaryNav");
      let deletedNav = document.getElementById("deletedNav");

      //variable for user inputs handling
      let date = document.getElementById("chooseDate");
      let taskName = document.getElementById("taskName");
      let priority = document.getElementById("prioritySelect");

      //variable for render tasks handling
      let dynamicUl = document.getElementById("dynamicUl");
      let taskModal = document.getElementById("taskModal");

      //variable for add tasks handling
      let addTaskBtn = document.getElementById("addTaskBtn");

      //variable for edit handling
      let addTaskModalBtn = document.getElementById("addTaskModalBtn");
      let editTaskBtn = document.getElementById("editTaskBtn");

      //variables for alerts handling
      let taskNameP = document.getElementById("taskNameP");
      let dateP = document.getElementById("dateP");
      let priorityP = document.getElementById("priorityP");

      // variables for summary handling
      let completed = document.getElementById("dynamicCompleted");
      let completedToday = document.getElementById("dynamicCompletedToday");

      //variable for expand Deleted Tasks handling
      let expandDeletedBtn = document.getElementById("expandDeletedBtn");

      //variable for deleted card handling
      let deletedCard = document.getElementById("deletedCard");

      //global variable to toggle between edit and new tasks
      let isEdit = "false";
      //global variable to find specific task to edit
      let editTaskId = 0;

      //handle local storage
      localStorage["tasks"] != undefined
        ? (tasks = JSON.parse(localStorage["tasks"]))
        : (tasks = []);

      localStorage["deletedTasks"] != undefined
        ? (deletedTasks = JSON.parse(localStorage["deletedTasks"]))
        : (deletedTasks = []);

      //render tasks to screen
      // TODO:CHECK IF I CAN DELETE TASKARR AND LEFT ONLY WITH tASK
      function renderTasksFunc(tasksArr) {
        dynamicUl.innerHTML = "";
        console.log(tasksArr);
        for (let i = 0; i < tasksArr.length; i++) {
          let str = "";
          if (tasksArr[i]["finishTask"]) {
            str += `<li class="list-group-item">
                      <h5 class="card-title text-decoration-line-through">
                        <i class="bi bi-clipboard-check pe-2" onClick="undoFinishTaskFunc(${tasksArr[i].taskId})"></i>
                      ${tasksArr[i]["taskName"]}
                      <i class="bi bi-trash3 trash" onclick="deleteTaskFunc(${tasksArr[i].taskId})"></i>
                      </h5>`;
            str += renderPriorityFunc(tasksArr[i]["priority"]);
            str += renderDateFunc(tasksArr[i]["date"]);
            str += `</li>`;
          } else {
            str += `<li class="list-group-item ">
                      <h5 class="card-title">
                      <input
                      class="form-check-input checkBox"
                      type="checkbox"
                      value=""
                      onclick="finishTaskFunc (${tasksArr[i].taskId})";
                    />
                    ${tasksArr[i]["taskName"]}
                     <i class="bi bi-trash3 trash" onclick="deleteTaskFunc(${tasksArr[i].taskId})"></i>
                     <i class="bi bi-pencil pencil"
                      data-bs-toggle="modal"
                      data-bs-target="#taskModal"
                      onclick="editTaskModalBtnFunc(${tasksArr[i].taskId})">
                      </i>
                      </h5>`;
            str += renderPriorityFunc(tasksArr[i]["priority"]);
            str += renderDateFunc(tasksArr[i]["date"]);
            str += `</li>`;
          }

          dynamicUl.innerHTML += str;
        }
      }

      //render priority
      function renderPriorityFunc(priorityVal) {
        let priorityObj = {
          1: ["high", "danger"],
          2: ["medium", "warning"],
          3: ["low", "info"],
        };
        let priority = priorityObj[`${priorityVal}`][0];
        let priorityColor = priorityObj[`${priorityVal}`][1];
        let str = `<h6 class="priority bg-gradient text-${priorityColor} mb-2 ">
                          ${priority}
                  </h6>`;
        return str;
      }

      //render date
      function renderDateFunc(date) {
        let str = ` <h6 class="card-subtitle mb-2 text-body-secondary">
                        <i class="bi bi-calendar"></i>
                        ${renderTodayOrDate(date)}
                    </h6>`;
        return str;
      }

      //check if today or another date
      function renderTodayOrDate(date) {
        let todayDate = Date.parse(new Date().toDateString()); //get the date value without consider time
        let taskDate = Date.parse(new Date(date).toDateString());
        let str = "";
        todayDate == taskDate ? (str = ` Today`) : (str = ` ${date}`);
        return str;
      }

      //render all the deleted tasks to the delete card
      function renderDeletedTasksFunc() {
        deletedCard.innerHTML = "";
        console.log(deletedTasks);
        for (let i = 0; i < deletedTasks.length; i++) {
          let str = "";
          str += `<li class="list-group-item">
              <h5 class="card-title text-decoration-line-through">
                ${deletedTasks[i].taskName}
              </h5>
              <h6 class="card-subtitle mb-2 text-body-secondary">
                <i class="bi bi-calendar"></i>
                ${deletedTasks[i].date}
              </h6>
            </li>`;
          deletedCard.innerHTML += str;
        }
      }

      // find task index
      const findIndex = (taskId) => {
        for (let i = 0; i < tasks.length; i++) {
          if (tasks[i]["taskId"].indexOf(taskId) != -1) return i;
        }
      };

      //delete task, update local storage, render remaining tasks to screen
      function deleteTaskFunc(taskId) {
        console.log(taskId);
        let taskIndex = findIndex(taskId);

        deletedTasks.unshift(tasks[taskIndex]);
        localStorage["deletedTasks"] = JSON.stringify(deletedTasks);

        tasks.splice(taskIndex, 1);
        localStorage["tasks"] = JSON.stringify(tasks);
        renderTasksFunc(tasks);
        summaryFunc();
        renderDeletedTasksFunc();
        deletedTasks.sort(function (a, b) {
          return Date.parse(a.date) - Date.parse(b.date);
        });
      }

      //finish task, update local storage, render tasks based on there finishTask value
      function finishTaskFunc(taskId) {
        let audio = new Audio("success-1-6297.mp3");
        audio.play();
        let index = findIndex(taskId);
        tasks[index]["finishTask"] = true;
        sortTasksFunction();
        localStorage["tasks"] = JSON.stringify(tasks);
        console.log(tasks);
        summaryFunc();
        setTimeout(function () {
          renderTasksFunc(tasks);
        }, 302);
      }

      //undo finish task, update local storage, render tasks based on there finishTask value
      function undoFinishTaskFunc(taskId) {
        let index = findIndex(taskId);
        tasks[index]["finishTask"] = false;
        sortTasksFunction();
        localStorage["tasks"] = JSON.stringify(tasks);
        summaryFunc();
        renderTasksFunc(tasks);
      }

      //sort by dates and if equal by priority
      function sortTasksFunction() {
        tasks.sort(function (a, b) {
          return (
            a.finishTask - b.finishTask ||
            Date.parse(a.date) - Date.parse(b.date) ||
            a.priority - b.priority
          );
        });
      }

      //function to change user ui from adding to edit
      function editTaskModalBtnFunc(taskId) {
        // TODO: check why i cant use the listeners from init it work with taskName and not with priority and date they undefined
        let taskIndex = findIndex(taskId);
        editTaskId = taskId;
        addTaskBtn.style.display = "none";
        editTaskBtn.style.display = "block";
        isEdit = "true";
        taskName.value = tasks[taskIndex].taskName;
        priority.value = tasks[taskIndex].priority;
        date.value = tasks[taskIndex].date;
      }

      //function for summarize
      // TODO:check if to change all the function i want to use localStorage
      function summaryFunc() {
        let todayTa = 0;
        let todayCo = 0;
        let totalCo = 0;
        let totalTasks = tasks.length + deletedTasks.length;
        let todayDate = Date.parse(new Date().toDateString()); //get the date value without consider time
        for (let i = 0; i < tasks.length; i++) {
          let taskDate = Date.parse(new Date(tasks[i].date).toDateString());
          if (todayDate == taskDate) {
            todayTa++;
            if (tasks[i].finishTask == true) {
              todayCo++;
            }
          }
          if (tasks[i].finishTask == true) {
            totalCo++;
          }
        }
        completed.innerHTML = totalCo + "/" + tasks.length;
        completedToday.innerHTML = todayCo + "/" + todayTa;
        dynamicTotalDeleted.innerHTML = deletedTasks.length;
      }

      //validation for task inputs from user
      const validationFunc = () => {
        let todayDate = Date.parse(new Date().toDateString()); //get the date value without consider time
        let taskDate = Date.parse(new Date(date.value).toDateString());
        let isSuccess = "true";

        if (taskDate < todayDate || isNaN(taskDate)) {
          dateP.textContent = "choose valid date";
          isSuccess = false;
        }
        if (taskName.value == "") {
          taskNameP.textContent = "choose valid name";
          isSuccess = false;
        }
        if (priority.value == "") {
          priorityP.textContent = "choose priority";
          isSuccess = false;
        }
        return isSuccess;
      };

      // add task, update the local storage, render tasks to screen.
      // or
      // handle edit task(delete the exist and add the edit one).
      const addTaskFunc = () => {
        if (validationFunc()) {
          if (isEdit) {
            deleteTaskFunc(editTaskId);
          }
          let task = {
            taskId: Date.now().toString(),
            taskName: taskName.value,
            priority: priority.value,
            date: date.value,
            finishTask: false,
          };

          tasks.push(task);
          sortTasksFunction();
          localStorage["tasks"] = JSON.stringify(tasks);
          renderTasksFunc(tasks);
          summaryFunc();
          location.reload();
        }
      };

      function expandDeletedFunc() {
        if (deletedCard.style.display == "none") {
          deletedCard.style.display = "block";
          renderDeletedTasksFunc();
        } else {
          deletedCard.style.display = "none";
        }
      }

      //clear alerts
      const cleanPAlertsFunc = (p) => {
        if (p.textContent !== "") p.textContent = "";
      };

      //event listeners - nav bar toggle
      allTasksNav.addEventListener("click", () => {
        taskDiv.style.display = "block";
        summaryDiv.style.display = "none";
        deleteDiv.style.display = "none";
      });

      summaryNav.addEventListener("click", () => {
        summaryDiv.style.display = "block";
        taskDiv.style.display = "none";
        deleteDiv.style.display = "none";
      });
      deletedNav.addEventListener("click", () => {
        deleteDiv.style.display = "block";
        summaryDiv.style.display = "none";
        taskDiv.style.display = "none";
      });

      //event listener - add task, clear alerts
      addTaskBtn.addEventListener("click", addTaskFunc);

      //event listener - edit task, clear alerts
      editTaskBtn.addEventListener("click", addTaskFunc);

      //event listener - show all deleted tasks
      expandDeletedBtn.addEventListener("click", expandDeletedFunc);

      //event listener - open modal for adding task
      addTaskModalBtn.addEventListener("click", () => {
        isEdit = false;
        addTaskBtn.style.display = "block";
        editTaskBtn.style.display = "none";
        taskName.value = "";
        priority.value = "";
        date.value = "";
      });

      //event listeners - clear alerts
      taskName.addEventListener("blur", () => {
        cleanPAlertsFunc(taskNameP);
      });
      date.addEventListener("blur", () => {
        cleanPAlertsFunc(dateP);
      });
      priority.addEventListener("blur", () => {
        cleanPAlertsFunc(priorityP);
      });

      //render all the tasks to the screen
      renderTasksFunc(tasks);

      //render summary to the screen
      summaryFunc();
    </script>
    <!-- my js  -->
    <!-- <script src="ToDo.js"></script> -->
  </body>
</html>
